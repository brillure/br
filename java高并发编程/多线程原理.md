# 多线程原理

## 1 进程与线程

### 1.1进程基本原理

在计算机中，操作系统负责进行资源的分配及任务的调度，应用程序以进程形式在操作系统之上运行。通常情况下，一个进程可有三部分构成，分别为程序段，数据段，和进程控制块。

进程控制块主要由4大部分构成：

（1）进程的描述信息。主要包括：进程ID和进程名称，进程ID是唯一的，代表进程的身份；进程状态，比如运行、就绪、阻塞；进程优先级，是进程调度的重要依据。

（2）进程的调度信息。主要包括：程序起始地址，程序的第一行指令的内存地址，从这里开始程序的执行；通信信息，进程间通信时的消息队列。

（3）进程的资源信息。主要包括：内存信息，内存占用情况和内存管理所用的数据结构；io设备信息，所用的io设备编号及相应的数据结构；文件句柄，所打开文件的信息。

（4）进程上下文。主要包括执行时各种CPU寄存器的值、当前程序计数器（PC）的值以及各种栈的值等，即进程的环境。



![image-20220219101349696](/Users/laniakea/Library/Application Support/typora-user-images/image-20220219101349696.png)

### 1.2线程基本原理

​		早期操作系统只有进程没有线程，进程是程序执行和系统并发调度的最小单位。随着计算机发展，为了充分发挥CPU的计算性能，提升CPU硬件资源的利用率，同时弥补进程调度过于笨重产生的问题，进程内部演进出了并发调度的诉求，于是就发明了线程。

​	    一个标准的线程主要由三部分组成，即线程描述信息，程序计数器和栈内存。

​		线程描述信息主要包括：线程ID，线程名称，线程优先级，线程状态，是否为守护线程。

![image-20220219103145029](/Users/laniakea/Library/Application Support/typora-user-images/image-20220219103145029.png)

​		JDK 1.8中，每个线程在创建时默认被分配1MB大小的栈内存。栈内存和堆内存不同，栈内存不受垃圾回收器管理。程序计数器，栈帧为线程私有。



### 1.3进程与线程区别

（1）线程是“进程代码段”的一次顺序执行流程。一个进程由一个或多个线程组成，一个进程至少有一个线程。

（2）线程是CPU调度的最小单位，进程是操作系统分配资源的最小单位。线程的划分尺度小于进程，使得多线程程序的并发性高。

（3）线程是出于高并发的调度诉求从进程内部演进而来的。线程的出现既充分发挥了CPU的计算性能，又弥补了进程调度过于笨重的问题。

（4）进程之间是相互独立的，但进程内部的各个线程之间并不完全独立。各个线程之间共享进程的方法区内存、堆内存、系统资源（文件句柄、系统信号等）。

（5）切换速度不同：线程上下文切换比进程上下文切换要快得多。所以，有的时候，线程也称为轻量级进程。

## 2 java创建线程的四种方法

### 2.1 继承Thread类创建

### 2.2 实现Runnable接口创建

### 2.3使用Callable和FutureTask创建线程

### 2.4通过线程池创建

## 3 线程的核心原理

### 3.1 线程的调度与时间片

### 3.2 线程的优先级

### 3.3 线程的生命周期

## 4 java线程操作基本方法

### 4.1 sleep

### 4.2 interrupt

### 4.3 join

### 4.4 yield

### 4.5 daemon

## 5 线程池原理与实战

### 5.1 JUC线程池架构

### 5.2 Excutors 4种创建线程池方法

### 5.3 线程池的标准创建方式

### 5.4 提交任务到线程池的两种方式

### 5.5 线程池的任务调度流程

### 5.6 工厂模式创建线程

### 5.7 AQS

### 5.8 调度器的钩子方法

### 5.9 线程池的拒绝策略

### 5.10 线程池的优雅关闭

## 6 确定线程池的线程数

### 6.1 io密集型

### 6.2 cpu密集型

### 6.3 混合型

## 7 ThreadLocal原理与实战

### 7.1 适用场景及基本使用

### 7.2 使用ThreadLocal进行线程隔离

### 7.3 使用ThreadLocal 进行跨函数数据传递

### 7.4 ThreadLocal 及ThreadLocalMap源码分析